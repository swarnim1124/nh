<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live PPE Safety Checker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .loader {
            border-top-color: #3498db;
            -webkit-animation: spin 1s linear infinite;
            animation: spin 1s linear infinite;
        }
        @-webkit-keyframes spin {
            0% { -webkit-transform: rotate(0deg); }
            100% { -webkit-transform: rotate(360deg); }
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        video {
            width: 100%;
            height: auto;
            border-radius: 0.5rem;
            transform: scaleX(-1); /* Mirror effect */
        }
        .whitespace-pre-wrap {
            white-space: pre-wrap;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <div class="max-w-4xl mx-auto bg-white rounded-2xl shadow-lg p-6 sm:p-8">
            <header class="text-center mb-6">
                <h1 class="text-3xl sm:text-4xl font-bold text-gray-900">Advanced Safety Monitoring System</h1>
                <p class="text-gray-600 mt-2">Real-time detection, audio alerts, safety reports, and actionable tips powered by LLM.</p>
            </header>

            <div class="bg-gray-50 p-6 rounded-xl border border-gray-200">
                <div class="flex flex-wrap justify-center items-center gap-4">
                    <button id="start-camera-btn" class="cursor-pointer bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-blue-700 transition-colors duration-300">Start Camera</button>
                    <button id="stop-camera-btn" class="hidden cursor-pointer bg-red-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-red-700 transition-colors duration-300">Stop Camera</button>
                    <button id="generate-report-btn" class="hidden cursor-pointer bg-green-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-green-700 transition-colors duration-300">âœ¨ Generate Report</button>
                    <button id="get-tips-btn" class="hidden cursor-pointer bg-purple-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-purple-700 transition-colors duration-300">âœ¨ Get Safety Tips</button>
                    <button id="mute-btn" class="cursor-pointer bg-gray-500 text-white p-3 rounded-full hover:bg-gray-600 transition-colors duration-300">
                        <svg id="unmuted-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" /></svg>
                        <svg id="muted-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2" /></svg>
                    </button>
                </div>
            </div>

            <div id="camera-container" class="mt-6 hidden">
                <h2 class="text-2xl font-semibold mb-4 text-center">Live Feed</h2>
                <div class="flex justify-center bg-black rounded-lg shadow-md"><video id="video-feed" autoplay playsinline></video></div>
                <canvas id="canvas" class="hidden"></canvas>
            </div>

            <div id="results-container" class="mt-8 hidden">
                <h2 class="text-2xl font-semibold mb-2 text-center flex items-center justify-center">Live Analysis<div id="loader" class="hidden ml-4 loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-6 w-6"></div></h2>
                <div class="grid md:grid-cols-2 gap-4">
                    <div id="ppe-result-text" class="text-lg bg-gray-50 p-6 rounded-xl border border-gray-200 min-h-[120px]"><p class="text-gray-500 text-center">Waiting for camera...</p></div>
                    <div id="hazard-result-text" class="text-lg bg-gray-50 p-6 rounded-xl border border-gray-200 min-h-[120px]"><p class="text-gray-500 text-center">Waiting for camera...</p></div>
                </div>
                 <div id="error-message" class="hidden mt-4 text-center text-red-600 bg-red-100 p-4 rounded-lg"></div>
            </div>
            
            <div id="violation-log-container" class="mt-8 hidden">
                <h2 class="text-2xl font-semibold mb-4 text-center">ðŸ“¸ Violation Log</h2>
                <div id="violation-log" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Violation screenshots will be appended here -->
                </div>
            </div>

            <div id="tips-container" class="mt-8 hidden">
                <h2 class="text-2xl font-semibold mb-2 text-center">âœ¨ Actionable Safety Tips</h2>
                <div id="tips-loader" class="hidden my-4 flex justify-center"><div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-16 w-16"></div></div>
                <div id="tips-text" class="text-base bg-purple-50 p-6 rounded-xl border border-purple-200 whitespace-pre-wrap"></div>
            </div>

            <div id="report-container" class="mt-8 hidden">
                <h2 class="text-2xl font-semibold mb-2 text-center">âœ¨ Safety Summary Report</h2>
                <div id="report-loader" class="hidden my-4 flex justify-center"><div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-24 w-24"></div></div>
                <div id="report-text" class="text-base bg-blue-50 p-6 rounded-xl border border-blue-200 whitespace-pre-wrap"></div>
            </div>

        </div>
        <footer class="text-center mt-8 text-gray-500 text-sm"><p>Powered by LLM's</p></footer>
    </div>

    <script>
        // ==========================
        // ðŸ”‘ API KEY CONFIGURED
        // ==========================
        const GEMINI_API_KEY = "AIzaSyDT5whYxLlavwMFOtqz17Jum9Wc3Arao-I"; // Your Gemini API key
        
        // DOM Elements
        const startCameraBtn = document.getElementById('start-camera-btn');
        const stopCameraBtn = document.getElementById('stop-camera-btn');
        const generateReportBtn = document.getElementById('generate-report-btn');
        const getTipsBtn = document.getElementById('get-tips-btn');
        const muteBtn = document.getElementById('mute-btn');
        const unmutedIcon = document.getElementById('unmuted-icon');
        const mutedIcon = document.getElementById('muted-icon');
        const cameraContainer = document.getElementById('camera-container');
        const videoFeed = document.getElementById('video-feed');
        const canvas = document.getElementById('canvas');
        const resultsContainer = document.getElementById('results-container');
        const loader = document.getElementById('loader');
        const ppeResultText = document.getElementById('ppe-result-text');
        const hazardResultText = document.getElementById('hazard-result-text');
        const errorMessage = document.getElementById('error-message');
        const reportContainer = document.getElementById('report-container');
        const reportLoader = document.getElementById('report-loader');
        const reportText = document.getElementById('report-text');
        const tipsContainer = document.getElementById('tips-container');
        const tipsLoader = document.getElementById('tips-loader');
        const tipsText = document.getElementById('tips-text');
        const violationLogContainer = document.getElementById('violation-log-container');
        const violationLog = document.getElementById('violation-log');

        // State variables
        let stream = null, analysisInterval = null;
        let isAnalyzing = false, isMuted = false;
        let sessionData = [], currentHazards = [];

        // Event Listeners
        startCameraBtn.addEventListener('click', startCamera);
        stopCameraBtn.addEventListener('click', stopCamera);
        generateReportBtn.addEventListener('click', generateSafetyReport);
        getTipsBtn.addEventListener('click', getSafetyTips);
        muteBtn.addEventListener('click', toggleMute);

        // --- Core Functions ---
        async function startCamera() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: true });
                videoFeed.srcObject = stream;
                updateUIForCameraStart();
                sessionData = [];
                currentHazards = [];
                analysisInterval = setInterval(captureAndAnalyze, 4000);
            } catch (err) {
                console.error("Error accessing camera: ", err);
                displayError("Could not access the camera. Please ensure you have a camera connected and have granted permission.");
            }
        }

        function stopCamera() {
            if (stream) stream.getTracks().forEach(track => track.stop());
            clearInterval(analysisInterval);
            isAnalyzing = false;
            updateUIForCameraStop();
        }

        async function captureAndAnalyze() {
            if (isAnalyzing || videoFeed.readyState < 2) return;
            isAnalyzing = true;
            loader.classList.remove('hidden');
            errorMessage.classList.add('hidden');
            canvas.width = videoFeed.videoWidth;
            canvas.height = videoFeed.videoHeight;
            canvas.getContext('2d').drawImage(videoFeed, 0, 0, canvas.width, canvas.height);
            const imageData = canvas.toDataURL('image/jpeg').split(',')[1];
            await analyzeImage(imageData);
            isAnalyzing = false;
        }
        
        // --- Gemini API Calls ---
        async function analyzeImage(imageData) {
            const prompt = `Analyze the image for workplace safety. 1. Check for a helmet. 2. Check for a high-visibility vest. 3. Identify up to 2 potential safety hazards in the background (e.g., clutter, spills, obstructions). Respond ONLY with a valid JSON object: {"hasHelmet": boolean, "hasVest": boolean, "hazards": string[]}. Example: {"hasHelmet": true, "hasVest": false, "hazards": ["Trip hazard from cables on floor"]}`;
            const payload = {
                contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: "image/jpeg", data: imageData }}]}]
            };
            try {
                const result = await callGemini(payload);
                let rawText = result.candidates[0].content.parts[0].text;
                rawText = rawText.replace(/```json/g, '').replace(/```/g, '').trim();
                const parsedJson = JSON.parse(rawText);
                sessionData.push(parsedJson);
                currentHazards = parsedJson.hazards || [];
                displayResults(parsedJson);
                triggerAudioAlerts(parsedJson);
            } catch (error) {
                console.error('Error in analyzeImage:', error);
                displayError("Failed to analyze image. Check console and verify your API key is correct.");
            } finally {
                loader.classList.add('hidden');
            }
        }

        async function generateSafetyReport() {
            reportContainer.classList.remove('hidden');
            reportLoader.classList.remove('hidden');
            tipsContainer.classList.add('hidden');
            reportText.innerHTML = "";
            generateReportBtn.disabled = true;

            const prompt = `Based on this series of JSON safety observations, write a brief, professional safety summary report. Include: 1. General PPE compliance. 2. Consistently detected hazards. 3. Actionable recommendations. Format with clear headings. Data: ${JSON.stringify(sessionData, null, 2)}`;
            try {
                const result = await callGemini({ contents: [{ parts: [{ text: prompt }] }] });
                reportText.textContent = result.candidates[0].content.parts[0].text;
            } catch (error) {
                console.error('Error generating report:', error);
                reportText.textContent = "Could not generate the report. Please check your API key.";
            } finally {
                reportLoader.classList.add('hidden');
                generateReportBtn.disabled = false;
            }
        }

        async function getSafetyTips() {
            if (currentHazards.length === 0) {
                tipsText.textContent = "No hazards currently detected to provide tips for.";
                tipsContainer.classList.remove('hidden');
                return;
            }
            tipsContainer.classList.remove('hidden');
            reportContainer.classList.add('hidden');
            tipsLoader.classList.remove('hidden');
            tipsText.innerHTML = "";
            getTipsBtn.disabled = true;

            const prompt = `For the following workplace safety hazards, provide 2-3 concise, actionable tips for each to mitigate the risk. Format the output clearly. Hazards: ${currentHazards.join(", ")}`;
            try {
                const result = await callGemini({ contents: [{ parts: [{ text: prompt }] }] });
                tipsText.textContent = result.candidates[0].content.parts[0].text;
            } catch (error) {
                console.error('Error getting safety tips:', error);
                tipsText.textContent = "Could not retrieve safety tips. Please check your API key.";
            } finally {
                tipsLoader.classList.add('hidden');
                getTipsBtn.disabled = false;
            }
        }
        
        async function speak(text) {
            if (isMuted) return;
            const payload = {
                contents: [{ parts: [{ text: `Say with a clear, warning tone: ${text}` }] }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: {
                        voiceConfig: {
                            prebuiltVoiceConfig: { voiceName: "Kore" }
                        }
                    }
                },
                model: "gemini-2.5-flash-preview-tts"
            };
            try {
                const result = await callGemini(payload, 'gemini-2.5-flash-preview-tts:generateContent');
                const part = result?.candidates?.[0]?.content?.parts?.[0];
                if (part?.inlineData?.data && part?.inlineData?.mimeType.startsWith("audio/")) {
                    const sampleRateMatch = part.inlineData.mimeType.match(/rate=(\d+)/);
                    if (!sampleRateMatch) {
                        console.error("Sample rate not found in mimeType");
                        return;
                    }
                    const sampleRate = parseInt(sampleRateMatch[1], 10);
                    const pcmData = base64ToArrayBuffer(part.inlineData.data);
                    const pcm16 = new Int16Array(pcmData);
                    const wavBlob = pcmToWav(pcm16, 1, sampleRate);
                    const audioUrl = URL.createObjectURL(wavBlob);
                    new Audio(audioUrl).play();
                }
            } catch (error) {
                console.error('TTS Error:', error);
            }
        }
        
        async function callGemini(payload, endpoint = 'gemini-2.5-flash-preview-05-20:generateContent') {
            // Check if API key is set
            if (!GEMINI_API_KEY || GEMINI_API_KEY === "YOUR_API_KEY_HERE") {
                throw new Error("API key not set. Please add your Gemini API key to the GEMINI_API_KEY variable.");
            }
            
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${endpoint}?key=${GEMINI_API_KEY}`;
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`HTTP error! status: ${response.status} - ${errorText}`);
            }
            return await response.json();
        }

        // --- UI & Display Functions ---
        function updateUIForCameraStart() {
            startCameraBtn.classList.add('hidden');
            stopCameraBtn.classList.remove('hidden');
            generateReportBtn.classList.add('hidden');
            getTipsBtn.classList.remove('hidden');
            cameraContainer.classList.remove('hidden');
            resultsContainer.classList.remove('hidden');
            reportContainer.classList.add('hidden');
            tipsContainer.classList.add('hidden');
            violationLogContainer.classList.add('hidden');
            violationLog.innerHTML = ''; // Clear previous logs
            errorMessage.classList.add('hidden');
            ppeResultText.innerHTML = '<p class="text-gray-500 text-center">Camera started. Point it at a worker...</p>';
            hazardResultText.innerHTML = '<p class="text-gray-500 text-center">Identifying hazards...</p>';
        }

        function updateUIForCameraStop() {
            startCameraBtn.classList.remove('hidden');
            stopCameraBtn.classList.add('hidden');
            cameraContainer.classList.add('hidden');
            loader.classList.add('hidden');
            getTipsBtn.classList.add('hidden');
            ppeResultText.innerHTML = '<p class="text-gray-500 text-center">Camera stopped.</p>';
            hazardResultText.innerHTML = '<p class="text-gray-500 text-center">Camera stopped.</p>';
            if (sessionData.length > 0) {
                generateReportBtn.classList.remove('hidden');
            }
        }
        
        function displayResults(data) {
            let ppeHTML = '<h3 class="text-lg font-semibold mb-3 text-center text-gray-700">PPE Status</h3><ul class="space-y-3">';
            ppeHTML += data.hasHelmet ? `<li class="flex items-center text-green-700 font-medium"><svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>Helmet: <strong>Detected</strong></li>` : `<li class="flex items-center text-red-700 font-medium"><svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>Helmet: <strong>Not Detected</strong></li>`;
            ppeHTML += data.hasVest ? `<li class="flex items-center text-green-700 font-medium"><svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>Safety Vest: <strong>Detected</strong></li>` : `<li class="flex items-center text-red-700 font-medium"><svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>Safety Vest: <strong>Not Detected</strong></li>`;
            ppeResultText.innerHTML = ppeHTML + '</ul>';

            let hazardHTML = '<h3 class="text-lg font-semibold mb-3 text-center text-gray-700">âœ¨ Hazard Detection</h3><ul class="space-y-3">';
            if (data.hazards && data.hazards.length > 0) {
                data.hazards.forEach(hazard => {
                    hazardHTML += `<li class="flex items-start text-yellow-800 font-medium"><svg class="w-5 h-5 mr-3 mt-1 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.21 3.03-1.742 3.03H4.42c-1.532 0-2.492-1.696-1.742-3.03l5.58-9.92zM10 13a1 1 0 110-2 1 1 0 010 2zm-1-4a1 1 0 011-1h.01a1 1 0 110 2H10a1 1 0 01-1-1z" clip-rule="evenodd"></path></svg><span>${hazard}</span></li>`;
                });
            } else {
                hazardHTML += `<li class="flex items-center text-gray-500">No immediate hazards detected.</li>`;
            }
            hazardResultText.innerHTML = hazardHTML + '</ul>';
        }

        function triggerAudioAlerts(data) {
            if (!data.hasHelmet || !data.hasVest) {
                speak("Warning, person is not wearing safety gear.");
                captureViolation();
            }
            if (data.hazards && data.hazards.length > 0) {
                speak(`Caution, ${data.hazards[0]}.`);
            }
        }

        function captureViolation() {
            const timestamp = new Date();
            const timestampString = timestamp.toLocaleString('en-IN', { timeZone: 'Asia/Kolkata' });

            // Redraw image on canvas to add timestamp
            const ctx = canvas.getContext('2d');
            ctx.drawImage(videoFeed, 0, 0, canvas.width, canvas.height);
            
            // Style and draw timestamp
            ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
            ctx.fillRect(0, canvas.height - 30, canvas.width, 30);
            ctx.font = '16px Inter';
            ctx.fillStyle = 'white';
            ctx.textAlign = 'left';
            ctx.fillText(timestampString, 10, canvas.height - 10);

            const dataUrl = canvas.toDataURL('image/jpeg');

            // Create and display the violation log entry
            violationLogContainer.classList.remove('hidden');
            const logEntry = document.createElement('div');
            logEntry.className = 'bg-white p-2 rounded-lg shadow';
            
            const img = document.createElement('img');
            img.src = dataUrl;
            img.className = 'rounded-md w-full h-auto';
            
            const caption = document.createElement('p');
            caption.className = 'text-center text-sm text-gray-600 mt-2';
            caption.textContent = timestampString;

            logEntry.appendChild(img);
            logEntry.appendChild(caption);
            violationLog.appendChild(logEntry);
        }

        function toggleMute() {
            isMuted = !isMuted;
            unmutedIcon.classList.toggle('hidden', isMuted);
            mutedIcon.classList.toggle('hidden', !isMuted);
        }
        
        function displayError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.remove('hidden');
        }

        // --- Audio Helper Functions ---
        function base64ToArrayBuffer(base64) {
            const binaryString = window.atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        function pcmToWav(pcmData, numChannels, sampleRate) {
            const buffer = new ArrayBuffer(44 + pcmData.length * 2);
            const view = new DataView(buffer);
            const writeString = (offset, string) => {
                for (let i = 0; i < string.length; i++) {
                    view.setUint8(offset + i, string.charCodeAt(i));
                }
            };
            const pcmLength = pcmData.length;
            writeString(0, 'RIFF');
            view.setUint32(4, 36 + pcmLength * 2, true);
            writeString(8, 'WAVE');
            writeString(12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, numChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * 2 * numChannels, true);
            view.setUint16(32, numChannels * 2, true);
            view.setUint16(34, 16, true);
            writeString(36, 'data');
            view.setUint32(40, pcmLength * 2, true);
            for (let i = 0; i < pcmLength; i++) {
                view.setInt16(44 + i * 2, pcmData[i], true);
            }
            return new Blob([view], { type: 'audio/wav' });
        }
    </script>
</body>
</html>